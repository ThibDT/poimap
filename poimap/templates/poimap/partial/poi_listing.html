{%load leaflet_tags sekizai_tags static %}

<div id="cards">

</div>

{% verbatim %}
<script id="poi-card-template" type="text/x-handlebars-template">
<div class="card border-light mb-3">
    <div class="row">
        <div class="col-3 col-sm-3 col-md-3">
            <img src="{{img_url}}" class="img-fluid img-thumbnail">
        </div>
        <div class="col-9 col-sm-9 col-md-9">
            <div class="card-body">
                <h4 class="card-title">{{title}}<span class="badge badge-secondary float-right">{{distance}} km</span></h4>
                <p class="card-text">{{description}}...<a href="{{url}}">Lire la suite</a></p>
            </div>
        </div>
     </div>
 </div>
</script>
{% endverbatim %}
{% addtoblock 'js' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js" charset="utf-8"></script>
<script type="text/javascript">
        var source   = document.getElementById("poi-card-template").innerHTML;
        var poiCardTemplate = Handlebars.compile(source);
        var lastCity = null;
        $(document).on("poimap:marker-added",  function(evt, poi){
            var context = {
                title: poi.properties.name,
                description: $(poi.properties.description).text().substring(0, 250),
                distance : poi.properties.distance / 1000,
                url : poi.properties.url,
            };
            if(poi.properties.medias.length > 0){
                context.img_url = "{{MEDIA_URL}}/"+poi.properties.medias[0]
            }
            else {
                context.img_url = "{% static 'img/no_picture.svg'%}"
            }
            if(lastCity != poi.properties.city){
                lastCity = poi.properties.city;
                $("#cards").append(`<h3 class=''>${lastCity}</h3>`);
            };
            $("#cards").append(poiCardTemplate(context));
        });
</script>
{% endaddtoblock %}
